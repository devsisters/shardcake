<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Getting Started | Shardcake</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/shardcake/shardcake.png">
    <meta name="description" content="Entity Sharding library for Scala">
    
    <link rel="preload" href="/shardcake/assets/css/0.styles.65c88f21.css" as="style"><link rel="preload" href="/shardcake/assets/js/app.f77f888a.js" as="script"><link rel="preload" href="/shardcake/assets/js/2.778bb4ad.js" as="script"><link rel="preload" href="/shardcake/assets/js/1.f8bb34da.js" as="script"><link rel="preload" href="/shardcake/assets/js/24.f52966e3.js" as="script"><link rel="prefetch" href="/shardcake/assets/js/10.fde088a2.js"><link rel="prefetch" href="/shardcake/assets/js/11.c62b6b34.js"><link rel="prefetch" href="/shardcake/assets/js/12.27d4f152.js"><link rel="prefetch" href="/shardcake/assets/js/13.3f3f6a36.js"><link rel="prefetch" href="/shardcake/assets/js/14.eb7a3d07.js"><link rel="prefetch" href="/shardcake/assets/js/15.114dfd5c.js"><link rel="prefetch" href="/shardcake/assets/js/16.85253907.js"><link rel="prefetch" href="/shardcake/assets/js/17.c2838453.js"><link rel="prefetch" href="/shardcake/assets/js/18.3256f17f.js"><link rel="prefetch" href="/shardcake/assets/js/19.d8afd0ae.js"><link rel="prefetch" href="/shardcake/assets/js/20.0d880388.js"><link rel="prefetch" href="/shardcake/assets/js/21.33b300c9.js"><link rel="prefetch" href="/shardcake/assets/js/22.b7c97fbe.js"><link rel="prefetch" href="/shardcake/assets/js/23.811260d0.js"><link rel="prefetch" href="/shardcake/assets/js/25.d539dff2.js"><link rel="prefetch" href="/shardcake/assets/js/26.45458d06.js"><link rel="prefetch" href="/shardcake/assets/js/27.88bc0b43.js"><link rel="prefetch" href="/shardcake/assets/js/3.af33e5d6.js"><link rel="prefetch" href="/shardcake/assets/js/4.45665f8a.js"><link rel="prefetch" href="/shardcake/assets/js/5.7098d77a.js"><link rel="prefetch" href="/shardcake/assets/js/6.0c0a0f39.js"><link rel="prefetch" href="/shardcake/assets/js/7.6a854e57.js"><link rel="prefetch" href="/shardcake/assets/js/vendors~docsearch.5e19b665.js">
    <link rel="stylesheet" href="/shardcake/assets/css/0.styles.65c88f21.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/shardcake/" class="home-link router-link-active"><img src="/shardcake/shardcake.png" alt="Shardcake" class="logo"> <span class="site-name can-hide">Shardcake</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/shardcake/docs/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Documentation
</a></div><div class="nav-item"><a href="/shardcake/about/" class="nav-link">
  About
</a></div><div class="nav-item"><a href="https://github.com/devsisters/shardcake" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/shardcake/docs/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Documentation
</a></div><div class="nav-item"><a href="/shardcake/about/" class="nav-link">
  About
</a></div><div class="nav-item"><a href="https://github.com/devsisters/shardcake" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Documentation</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/shardcake/docs/" aria-current="page" class="active sidebar-link">Getting Started</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/shardcake/docs/#a-simple-use-case" class="sidebar-link">A simple use case</a></li><li class="sidebar-sub-header"><a href="/shardcake/docs/#terminology" class="sidebar-link">Terminology</a></li><li class="sidebar-sub-header"><a href="/shardcake/docs/#key-components" class="sidebar-link">Key components</a></li><li class="sidebar-sub-header"><a href="/shardcake/docs/#an-example" class="sidebar-link">An example</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/shardcake/docs/#shard-manager" class="sidebar-link">Shard Manager</a></li><li class="sidebar-sub-header"><a href="/shardcake/docs/#entity-behavior" class="sidebar-link">Entity Behavior</a></li><li class="sidebar-sub-header"><a href="/shardcake/docs/#run-the-application" class="sidebar-link">Run the application</a></li><li class="sidebar-sub-header"><a href="/shardcake/docs/#where-to-go-from-there" class="sidebar-link">Where to go from there?</a></li></ul></li></ul></li><li><a href="/shardcake/docs/architecture.html" class="sidebar-link">Architecture</a></li><li><a href="/shardcake/docs/config.html" class="sidebar-link">Configuration</a></li><li><a href="/shardcake/docs/customization.html" class="sidebar-link">Customization</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="getting-started"><a href="#getting-started" class="header-anchor">#</a> Getting Started</h1> <p><strong>Shardcake</strong> is a <strong>Scala open source library</strong> that makes it easy to distribute entities across multiple servers and interact with those entities using their ID without knowing their actual location (this is also known as <em>location transparency</em>).</p> <p>Shardcake exposes a <strong>purely functional API</strong> and depends heavily on <a href="https://zio.dev" target="_blank" rel="noopener noreferrer">ZIO<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. It is recommended to be familiar with ZIO to read this documentation.</p> <h2 id="a-simple-use-case"><a href="#a-simple-use-case" class="header-anchor">#</a> A simple use case</h2> <p>We are building a multiplayer game where <strong>users</strong> can join <strong>guilds</strong>.
We expect our game to be successful, so we need to be able to scale out (deploy it on multiple servers to handle the load).</p> <p>A guild is limited to 30 members.
Let's consider the case where 2 users try to join a guild at the exact same time, but our guild already had 29 members.</p> <p><img src="/shardcake/usecase1.png" alt="naive diagram"></p> <p>If we implement this naively, 2 different servers might receive our 2 requests to join the guild.
They will both check the current size of the guild at the same time, which will be 29 and they will both accept the new guild member. Now our guild has 31 members ðŸ˜±.</p> <p>There are 2 common approaches to deal with this issue:</p> <ul><li><strong>Global lock</strong> approach: when checking the members of the guild, acquire a lock that is shared between the different game servers, and release it after saving the new member.
That way, if 2 different game servers try to do it at the same time, the 2nd one will wait for the first one to finish.</li> <li><strong>Single writer</strong> approach: instead of handling the requests on 2 game servers concurrently, redirect the 2 requests to a single entity that will handle them sequentially.</li></ul> <p><strong>Entity Sharding</strong> is a way to implement the second approach. In this case our entities (here, our guilds) will be spread across our game servers so that
each entity exists in only one place at the time.</p> <p><img src="/shardcake/usecase2.png" alt="single writer diagram"></p> <p>If our entity might be on any game server, how do we know where it is? This is the second characteristic of entity sharding, known as location transparency: we only need to know the entity ID.
Using the entity ID, the sharding system will be able to find on which server the entity is located.</p> <p><strong>Shardcake</strong> provides components to:</p> <ul><li>automatically manage the assignments of entities to game servers</li> <li>send messages to your entities using their IDs</li></ul> <p>Once sharding is setup, it will let you write code like the following (sending a message to guild regardless of its location):</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">def</span> joinGuild<span class="token punctuation">(</span>guildId<span class="token operator">:</span> GuildId<span class="token punctuation">)</span><span class="token operator">:</span> ZIO<span class="token punctuation">[</span>Context<span class="token punctuation">,</span> Throwable<span class="token punctuation">,</span> GuildState<span class="token punctuation">]</span> <span class="token operator">=</span>
  <span class="token keyword">for</span> <span class="token punctuation">{</span>
    userId     <span class="token keyword">&lt;-</span> getCurrentUserFromContext
    guildState <span class="token keyword">&lt;-</span> guild<span class="token punctuation">.</span>send<span class="token punctuation">(</span>guildId<span class="token punctuation">)</span><span class="token punctuation">(</span>JoinGuild<span class="token punctuation">(</span>userId<span class="token punctuation">,</span> _<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">yield</span> guildState
</code></pre></div><h2 id="terminology"><a href="#terminology" class="header-anchor">#</a> Terminology</h2> <p>Before we go further, let's define a few terms:</p> <ul><li>An <strong>entity</strong> is a small message handler that can be addressed by ID.
For example, <code>User A</code> or <code>Guild B</code> are entities. In this case we say that <code>User</code> and <code>Guild</code> are <strong>entity types</strong>.</li> <li>A <strong>pod</strong> is an application server that can host entities.
Entities usually run on multiple pods, but a single entity will only run on a single pod at the time. You will never have the same entity running on 2 different pods.</li> <li>A <strong>shard</strong> is a logical group of entities that will always be located on the same pod.
There might be millions of entities, so instead of keeping millions of entities-to-pods mappings, we group entities into shards and maintain reasonably-sized shards-to-pods mappings.</li></ul> <h2 id="key-components"><a href="#key-components" class="header-anchor">#</a> Key components</h2> <p>Shardcake is composed of 2 main components:</p> <ul><li>The <strong>Shard Manager</strong> is an independent component that needs a single instance running. It is in charge of assigning shards to pods.</li> <li><strong>Entities</strong> will run on your application servers and process messages that are sent to them. Note that the entity behavior (including entity persistence) is entirely up to you.
Shardcake only takes care of starting entities on the right pods as well as the communication between them.</li></ul> <p>There are 4 pluggable parts that can be implemented with the technology of your choice.</p> <ul><li>The <code>Storage</code> trait defines where shard assignments will be stored. Shardcake provides an implementation using <strong>Redis</strong>.</li> <li>The <code>Pods</code> trait defines how to communicate with remote pods. Shardcake provides an implementation using <strong>gRPC</strong> as the protocol.</li> <li>The <code>Serialization</code> defines how to encode and decode messages. Shardcake provides an implementation using <strong>Kryo</strong>.</li> <li>The <code>PodsHealth</code> trait defines how to check if a pod is healthy or not. Shardcake provides an implementation using the <strong>k8s API</strong>.</li></ul> <p><img src="/shardcake/arch.png" alt="architecture diagram"></p> <h2 id="an-example"><a href="#an-example" class="header-anchor">#</a> An example</h2> <h3 id="shard-manager"><a href="#shard-manager" class="header-anchor">#</a> Shard Manager</h3> <p>The first thing we need to do is starting the Shard Manager. This component is available by importing the <code>shardcake-manager</code> dependency, and requires implementations of <code>Storage</code>, <code>Pods</code> and <code>PodsHealth</code> to work.</p> <p>To make it simpler and run our example without 3rd parties, we're going to run a simple <code>PodsHealth</code> implementation that just pings a pod to see if it's alive, and in-memory <code>Storage</code>.
We need a proper messaging protocol to communicate with pods, so we're going to use <code>shardcake-protocol-grpc</code>.</p> <div class="language- extra-class"><pre class="language-text"><code>libraryDependencies += &quot;com.devsisters&quot; %% &quot;shardcake-manager&quot;       % &quot;2.1.0&quot;
libraryDependencies += &quot;com.devsisters&quot; %% &quot;shardcake-protocol-grpc&quot; % &quot;2.1.0&quot;
</code></pre></div><p>The Shard Manager exposes a small GraphQL API, which means we need to start a small webserver. This can be done by calling <code>Server.run</code> and providing all the required dependencies.</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>devsisters<span class="token punctuation">.</span>shardcake<span class="token punctuation">.</span></span>_
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>devsisters<span class="token punctuation">.</span>shardcake<span class="token punctuation">.</span>interfaces<span class="token punctuation">.</span></span>_
<span class="token keyword">import</span> <span class="token namespace">zio<span class="token punctuation">.</span></span>_

<span class="token keyword">object</span> ShardManagerApp <span class="token keyword">extends</span> ZIOAppDefault <span class="token punctuation">{</span>
  <span class="token keyword">def</span> run<span class="token operator">:</span> Task<span class="token punctuation">[</span><span class="token builtin">Nothing</span><span class="token punctuation">]</span> <span class="token operator">=</span>
    Server<span class="token punctuation">.</span>run<span class="token punctuation">.</span>provide<span class="token punctuation">(</span>
      ZLayer<span class="token punctuation">.</span>succeed<span class="token punctuation">(</span>ManagerConfig<span class="token punctuation">.</span>default<span class="token punctuation">)</span><span class="token punctuation">,</span>
      ZLayer<span class="token punctuation">.</span>succeed<span class="token punctuation">(</span>GrpcConfig<span class="token punctuation">.</span>default<span class="token punctuation">)</span><span class="token punctuation">,</span>
      PodsHealth<span class="token punctuation">.</span>local<span class="token punctuation">,</span> <span class="token comment">// just ping a pod to see if it's alive</span>
      GrpcPods<span class="token punctuation">.</span>live<span class="token punctuation">,</span>    <span class="token comment">// use gRPC protocol</span>
      Storage<span class="token punctuation">.</span>memory<span class="token punctuation">,</span>   <span class="token comment">// store data in memory</span>
      ShardManager<span class="token punctuation">.</span>live <span class="token comment">// shard manager logic</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>That's it! Running this small app will start the Shard Manager and its API. It is now ready to receive registration from pods.</p> <h3 id="entity-behavior"><a href="#entity-behavior" class="header-anchor">#</a> Entity Behavior</h3> <p>We now need to define our <strong>entity behavior</strong>: what kind of messages can our entity receive, and what to do when it receives those messages. We will model our <strong>Guild</strong> example.</p> <p>First, we need the following dependencies:</p> <div class="language- extra-class"><pre class="language-text"><code>libraryDependencies += &quot;com.devsisters&quot; %% &quot;shardcake-entities&quot;      % &quot;2.1.0&quot;
libraryDependencies += &quot;com.devsisters&quot; %% &quot;shardcake-protocol-grpc&quot; % &quot;2.1.0&quot;
</code></pre></div><p>Let's start with defining the messages our entities can receive. We will have 2: one for joining a guild and one for leaving.
We create a <code>sealed trait</code> that will contain all the possible message types.
Any message that can be replied needs to contain a <code>Replier[A]</code> where <code>A</code> is the response type.</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">sealed</span> <span class="token keyword">trait</span> GuildMessage

<span class="token keyword">object</span> GuildMessage <span class="token punctuation">{</span>
  <span class="token keyword">case</span> <span class="token keyword">class</span> Join<span class="token punctuation">(</span>userId<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> replier<span class="token operator">:</span> Replier<span class="token punctuation">[</span>Try<span class="token punctuation">[</span>Set<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> GuildMessage
  <span class="token keyword">case</span> <span class="token keyword">class</span> Leave<span class="token punctuation">(</span>userId<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span>                                    <span class="token keyword">extends</span> GuildMessage
<span class="token punctuation">}</span>
</code></pre></div><p>We also need to define an <strong>Entity Type</strong>. This is done by extending <code>EntityType</code> with the message type as well as a unique <code>String</code> identifier for this type.</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">object</span> Guild <span class="token keyword">extends</span> EntityType<span class="token punctuation">[</span>GuildMessage<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;guild&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>The behavior itself is a function with the following signature:</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">def</span> behavior<span class="token punctuation">(</span>entityId<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> messages<span class="token operator">:</span> Queue<span class="token punctuation">[</span>GuildMessage<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> RIO<span class="token punctuation">[</span>Sharding<span class="token punctuation">,</span> <span class="token builtin">Nothing</span><span class="token punctuation">]</span>
</code></pre></div><p>It takes an <code>entityId</code> and a <code>Queue[GuildMessage]</code> and returns a <code>ZIO</code> that never ends (hence the return type <code>Nothing</code>).
That function is just supposed to consume <code>messages</code> forever.</p> <p>Let's first define how to handle a single <code>GuildMessage</code>.</p> <p>We will use a <code>Ref[Set[String]]</code> to hold our state (the list of users in the guild).
When we receive a <code>Join</code> request, we check if the guild is already full (here, we hardcode the max to 5) and respond with a failure or modify the state and respond with a success.
We use <code>replier.reply</code> to send a response to the sender (here, sending the full list of guild members wrapped in a <code>Try</code> to express errors).</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">def</span> handleMessage<span class="token punctuation">(</span>state<span class="token operator">:</span> Ref<span class="token punctuation">[</span>Set<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> message<span class="token operator">:</span> GuildMessage<span class="token punctuation">)</span><span class="token operator">:</span> RIO<span class="token punctuation">[</span>Sharding<span class="token punctuation">,</span> <span class="token builtin">Unit</span><span class="token punctuation">]</span> <span class="token operator">=</span>
  message <span class="token keyword">match</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> GuildMessage<span class="token punctuation">.</span>Join<span class="token punctuation">(</span>userId<span class="token punctuation">,</span> replier<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span>
      state<span class="token punctuation">.</span>get<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>members <span class="token keyword">=&gt;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>members<span class="token punctuation">.</span>size <span class="token operator">&gt;=</span> <span class="token number">5</span><span class="token punctuation">)</span>
          replier<span class="token punctuation">.</span>reply<span class="token punctuation">(</span>Failure<span class="token punctuation">(</span><span class="token keyword">new</span> Exception<span class="token punctuation">(</span><span class="token string">&quot;Guild is already full!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span>
          state<span class="token punctuation">.</span>updateAndGet<span class="token punctuation">(</span>_ <span class="token operator">+</span> userId<span class="token punctuation">)</span><span class="token punctuation">.</span>flatMap <span class="token punctuation">{</span> newMembers <span class="token keyword">=&gt;</span>
            replier<span class="token punctuation">.</span>reply<span class="token punctuation">(</span>Success<span class="token punctuation">(</span>newMembers<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">)</span>
    <span class="token keyword">case</span> GuildMessage<span class="token punctuation">.</span>Leave<span class="token punctuation">(</span>userId<span class="token punctuation">)</span>         <span class="token keyword">=&gt;</span>
      state<span class="token punctuation">.</span>update<span class="token punctuation">(</span>_ <span class="token operator">-</span> userId<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>We are now ready to create our behavior, starting from an empty state when the entity is created:</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">def</span> behavior<span class="token punctuation">(</span>entityId<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> messages<span class="token operator">:</span> Queue<span class="token punctuation">[</span>GuildMessage<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> RIO<span class="token punctuation">[</span>Sharding<span class="token punctuation">,</span> <span class="token builtin">Nothing</span><span class="token punctuation">]</span> <span class="token operator">=</span>
  Ref
    <span class="token punctuation">.</span>make<span class="token punctuation">(</span>Set<span class="token punctuation">.</span>empty<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>state <span class="token keyword">=&gt;</span> messages<span class="token punctuation">.</span>take<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>handleMessage<span class="token punctuation">(</span>state<span class="token punctuation">,</span> _<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>forever<span class="token punctuation">)</span>
</code></pre></div><h3 id="run-the-application"><a href="#run-the-application" class="header-anchor">#</a> Run the application</h3> <p>To run our entities, we need to register their behavior to the Sharding system, which is done by calling <code>Sharding.registerEntity</code>, passing the entity type and the behavior.</p> <p>We then need to notify the Shard Manager that a new pod is now ready to run entities, and shards may be assigned to it.
This is done by calling <code>Sharding.registerScoped</code> (which is the equivalent of calling <code>Sharding.register</code> when the program starts and <code>Sharding.unregister</code> when the program ends).</p> <p>To communicate with our entities, we need a <code>Messenger[GuildMessage]</code>, which we get by calling <code>Sharding.messenger</code>. You can even use <code>messenger</code> on a pod that is not hosting any entities.</p> <div class="language-scala extra-class"><pre class="language-scala"><code>  <span class="token keyword">val</span> program <span class="token operator">=</span>
    <span class="token keyword">for</span> <span class="token punctuation">{</span>
      _     <span class="token keyword">&lt;-</span> Sharding<span class="token punctuation">.</span>registerEntity<span class="token punctuation">(</span>Guild<span class="token punctuation">,</span> behavior<span class="token punctuation">)</span>
      _     <span class="token keyword">&lt;-</span> Sharding<span class="token punctuation">.</span>registerScoped
      guild <span class="token keyword">&lt;-</span> Sharding<span class="token punctuation">.</span>messenger<span class="token punctuation">(</span>Guild<span class="token punctuation">)</span>
      _     <span class="token keyword">&lt;-</span> guild<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">&quot;guild1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span>Join<span class="token punctuation">(</span><span class="token string">&quot;user1&quot;</span><span class="token punctuation">,</span> _<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>debug
      _     <span class="token keyword">&lt;-</span> guild<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">&quot;guild1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span>Join<span class="token punctuation">(</span><span class="token string">&quot;user2&quot;</span><span class="token punctuation">,</span> _<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>debug
      _     <span class="token keyword">&lt;-</span> guild<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">&quot;guild1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span>Join<span class="token punctuation">(</span><span class="token string">&quot;user3&quot;</span><span class="token punctuation">,</span> _<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>debug
      _     <span class="token keyword">&lt;-</span> guild<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">&quot;guild1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span>Join<span class="token punctuation">(</span><span class="token string">&quot;user4&quot;</span><span class="token punctuation">,</span> _<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>debug
      _     <span class="token keyword">&lt;-</span> guild<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">&quot;guild1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span>Join<span class="token punctuation">(</span><span class="token string">&quot;user5&quot;</span><span class="token punctuation">,</span> _<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>debug
      _     <span class="token keyword">&lt;-</span> guild<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">&quot;guild1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span>Join<span class="token punctuation">(</span><span class="token string">&quot;user6&quot;</span><span class="token punctuation">,</span> _<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>debug
    <span class="token punctuation">}</span> <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>Finally, we provide all required dependencies as we did for the Shard Manager.</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">def</span> run<span class="token operator">:</span> Task<span class="token punctuation">[</span><span class="token builtin">Unit</span><span class="token punctuation">]</span> <span class="token operator">=</span>
  ZIO<span class="token punctuation">.</span>scoped<span class="token punctuation">(</span>program<span class="token punctuation">)</span><span class="token punctuation">.</span>provide<span class="token punctuation">(</span>
    ZLayer<span class="token punctuation">.</span>succeed<span class="token punctuation">(</span>Config<span class="token punctuation">.</span>default<span class="token punctuation">)</span><span class="token punctuation">,</span>
    ZLayer<span class="token punctuation">.</span>succeed<span class="token punctuation">(</span>GrpcConfig<span class="token punctuation">.</span>default<span class="token punctuation">)</span><span class="token punctuation">,</span>
    Serialization<span class="token punctuation">.</span>javaSerialization<span class="token punctuation">,</span> <span class="token comment">// use java serialization for messages</span>
    Storage<span class="token punctuation">.</span>memory<span class="token punctuation">,</span>                  <span class="token comment">// store data in memory</span>
    ShardManagerClient<span class="token punctuation">.</span>liveWithSttp<span class="token punctuation">,</span> <span class="token comment">// client to communicate with the Shard Manager</span>
    GrpcPods<span class="token punctuation">.</span>live<span class="token punctuation">,</span>                   <span class="token comment">// use gRPC protocol</span>
    GrpcShardingService<span class="token punctuation">.</span>live<span class="token punctuation">,</span>        <span class="token comment">// expose gRPC service</span>
    Sharding<span class="token punctuation">.</span>live                    <span class="token comment">// sharding logic</span>
  <span class="token punctuation">)</span>
</code></pre></div><p>We can now run our program. It will successively send 6 <code>Join</code> messages to our guild and print the result:</p> <div class="language- extra-class"><pre class="language-text"><code>Success(Set(user1))
Success(Set(user1, user2))
Success(Set(user1, user2, user3))
Success(Set(user1, user2, user3, user4))
Success(HashSet(user1, user5, user4, user2, user3))
Failure(java.lang.Exception: Guild is already full!)
</code></pre></div><h4 id="one-more-thing"><a href="#one-more-thing" class="header-anchor">#</a> One more thing...</h4> <p><code>Sharding</code> also exposes 2 methods that can be interesting for some use cases:</p> <ul><li><code>registerSingleton</code> lets you register some background processes that will run in only one pod at any given time. Singletons can't receive messages and they are not stopped in case of inactivity.</li> <li><code>registerTopic</code> lets you broadcast messages to all registered pods (use <code>Sharding.broadcaster</code> instead of <code>Sharding.messenger</code>).</li></ul> <h3 id="where-to-go-from-there"><a href="#where-to-go-from-there" class="header-anchor">#</a> Where to go from there?</h3> <p>In this simple example, we only had a single pod so there was no real benefit from using sharding.
But we could run the exact same code on multiple pods, and the sharding system would ensure that each guild is only running on a single pod.
In other words, all messages sent to <code>guild1</code> would be handled by the same pod.</p> <p>The only changes we would need to make would be:</p> <ul><li>to use an actual <code>Storage</code> implementation for sharding (e.g. Redis)</li> <li>to save our guild state somewhere instead of in memory, so that we don't lose this state if the guild entity is moved from one pod to another</li></ul> <p>The running code for this example <a href="https://github.com/devsisters/shardcake/tree/series/2.x/examples/src/main/scala/example/simple" target="_blank" rel="noopener noreferrer">can be found here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>,
as well as <a href="https://github.com/devsisters/shardcake/tree/series/2.x/examples/src/main/scala/example/complex" target="_blank" rel="noopener noreferrer">a more complex example<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> using Redis to persist data and where you can run multiple pods.</p> <p>To understand how Sharding works under the hood, have a look at the <a href="/shardcake/docs/architecture.html">Architecture</a> section.
The <a href="/shardcake/docs/config.html">Configuration</a> section explains how to configure the sharding system.
Finally, the <a href="/shardcake/docs/customization.html">Customization</a> section describes how you can use your own storage, serialization or messaging protocol, as well as the options provided by Shardcake.</p> <div class="custom-block tip"><p class="custom-block-title">Differences with Akka Cluster Sharding ?</p> <p><a href="https://doc.akka.io/docs/akka/current/typed/cluster-sharding.html" target="_blank" rel="noopener noreferrer">Akka Cluster Sharding<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> is the main alternative for sharding in Scala.
Here is how Shardcake differs from Akka:</p> <ul><li><p>Shardcake is a <strong>purely functional library</strong> based on <code>ZIO</code>, while Akka is a library leaning towards the &quot;better Java&quot; style of Scala and is based on <code>Future</code>.</p></li> <li><p>With Akka, all application servers <strong>must be part of a cluster</strong>. This is particularly tricky to configure and sensitive to all kinds of failures.
This is not the case with Shardcake since the Shard Manager is an external component that relies on systems like Kubernetes to monitor pod health.</p></li> <li><p>Akka is way more than a sharding library, this is basically an entire framework that has a lot of features.
Shardcake is much <strong>simpler and modular</strong>. It lets you customize multiple things, including the messaging protocol between pods.</p></li> <li><p>Akka is backed by <a href="https://www.lightbend.com" target="_blank" rel="noopener noreferrer">Lightbend<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, who provides <strong>commercial support</strong>,
while Shardcake is backed by <a href="https://www.devsisters.com" target="_blank" rel="noopener noreferrer">Devsisters<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and the <strong>ZIO community</strong>.</p></li></ul></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/shardcake/docs/architecture.html">
        Architecture
      </a>
      â†’
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/shardcake/assets/js/app.f77f888a.js" defer></script><script src="/shardcake/assets/js/2.778bb4ad.js" defer></script><script src="/shardcake/assets/js/1.f8bb34da.js" defer></script><script src="/shardcake/assets/js/24.f52966e3.js" defer></script>
  </body>
</html>
