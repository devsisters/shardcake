<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Customization | Shardcake</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/shardcake/shardcake.png">
    <meta name="description" content="Entity Sharding library for Scala">
    
    <link rel="preload" href="/shardcake/assets/css/0.styles.65c88f21.css" as="style"><link rel="preload" href="/shardcake/assets/js/app.f77f888a.js" as="script"><link rel="preload" href="/shardcake/assets/js/2.778bb4ad.js" as="script"><link rel="preload" href="/shardcake/assets/js/1.f8bb34da.js" as="script"><link rel="preload" href="/shardcake/assets/js/27.88bc0b43.js" as="script"><link rel="prefetch" href="/shardcake/assets/js/10.fde088a2.js"><link rel="prefetch" href="/shardcake/assets/js/11.c62b6b34.js"><link rel="prefetch" href="/shardcake/assets/js/12.27d4f152.js"><link rel="prefetch" href="/shardcake/assets/js/13.3f3f6a36.js"><link rel="prefetch" href="/shardcake/assets/js/14.eb7a3d07.js"><link rel="prefetch" href="/shardcake/assets/js/15.114dfd5c.js"><link rel="prefetch" href="/shardcake/assets/js/16.85253907.js"><link rel="prefetch" href="/shardcake/assets/js/17.c2838453.js"><link rel="prefetch" href="/shardcake/assets/js/18.3256f17f.js"><link rel="prefetch" href="/shardcake/assets/js/19.d8afd0ae.js"><link rel="prefetch" href="/shardcake/assets/js/20.0d880388.js"><link rel="prefetch" href="/shardcake/assets/js/21.33b300c9.js"><link rel="prefetch" href="/shardcake/assets/js/22.b7c97fbe.js"><link rel="prefetch" href="/shardcake/assets/js/23.811260d0.js"><link rel="prefetch" href="/shardcake/assets/js/24.f52966e3.js"><link rel="prefetch" href="/shardcake/assets/js/25.d539dff2.js"><link rel="prefetch" href="/shardcake/assets/js/26.45458d06.js"><link rel="prefetch" href="/shardcake/assets/js/3.af33e5d6.js"><link rel="prefetch" href="/shardcake/assets/js/4.45665f8a.js"><link rel="prefetch" href="/shardcake/assets/js/5.7098d77a.js"><link rel="prefetch" href="/shardcake/assets/js/6.0c0a0f39.js"><link rel="prefetch" href="/shardcake/assets/js/7.6a854e57.js"><link rel="prefetch" href="/shardcake/assets/js/vendors~docsearch.5e19b665.js">
    <link rel="stylesheet" href="/shardcake/assets/css/0.styles.65c88f21.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/shardcake/" class="home-link router-link-active"><img src="/shardcake/shardcake.png" alt="Shardcake" class="logo"> <span class="site-name can-hide">Shardcake</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/shardcake/docs/" class="nav-link router-link-active">
  Documentation
</a></div><div class="nav-item"><a href="/shardcake/about/" class="nav-link">
  About
</a></div><div class="nav-item"><a href="https://github.com/devsisters/shardcake" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/shardcake/docs/" class="nav-link router-link-active">
  Documentation
</a></div><div class="nav-item"><a href="/shardcake/about/" class="nav-link">
  About
</a></div><div class="nav-item"><a href="https://github.com/devsisters/shardcake" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Documentation</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/shardcake/docs/" aria-current="page" class="sidebar-link">Getting Started</a></li><li><a href="/shardcake/docs/architecture.html" class="sidebar-link">Architecture</a></li><li><a href="/shardcake/docs/config.html" class="sidebar-link">Configuration</a></li><li><a href="/shardcake/docs/customization.html" aria-current="page" class="active sidebar-link">Customization</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/shardcake/docs/customization.html#storage" class="sidebar-link">Storage</a></li><li class="sidebar-sub-header"><a href="/shardcake/docs/customization.html#messaging-protocol" class="sidebar-link">Messaging Protocol</a></li><li class="sidebar-sub-header"><a href="/shardcake/docs/customization.html#serialization" class="sidebar-link">Serialization</a></li><li class="sidebar-sub-header"><a href="/shardcake/docs/customization.html#health" class="sidebar-link">Health</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="customization"><a href="#customization" class="header-anchor">#</a> Customization</h1> <p>As demonstrated in the <a href="/shardcake/docs/#key-components">Getting Started</a>, there are several parts of the system that are entirely customizable.
For each of them, Shardcake provides at least a fake implementation for testing and a prod-ready implementation using common technologies.</p> <p>Feel free to implement your own!</p> <p><img src="/shardcake/arch.png" alt="architecture diagram"></p> <h2 id="storage"><a href="#storage" class="header-anchor">#</a> Storage</h2> <p>The <code>Storage</code> trait defines how to store and access pods and shards assignments.
It contains 5 methods: <code>getAssignments</code>/<code>saveAssignments</code> to store assignments, <code>getPods</code>/<code>savePods</code> to store pods, and <code>assignmentsStream</code> to receive assignment updates.</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">trait</span> Storage <span class="token punctuation">{</span>
  <span class="token keyword">def</span> getAssignments<span class="token operator">:</span> Task<span class="token punctuation">[</span>Map<span class="token punctuation">[</span>ShardId<span class="token punctuation">,</span> Option<span class="token punctuation">[</span>PodAddress<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
  <span class="token keyword">def</span> saveAssignments<span class="token punctuation">(</span>assignments<span class="token operator">:</span> Map<span class="token punctuation">[</span>ShardId<span class="token punctuation">,</span> Option<span class="token punctuation">[</span>PodAddress<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Task<span class="token punctuation">[</span><span class="token builtin">Unit</span><span class="token punctuation">]</span>
  
  <span class="token keyword">def</span> assignmentsStream<span class="token operator">:</span> ZStream<span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span> Throwable<span class="token punctuation">,</span> Map<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">,</span> Option<span class="token punctuation">[</span>PodAddress<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
  
  <span class="token keyword">def</span> getPods<span class="token operator">:</span> Task<span class="token punctuation">[</span>Map<span class="token punctuation">[</span>PodAddress<span class="token punctuation">,</span> Pod<span class="token punctuation">]</span><span class="token punctuation">]</span>
  <span class="token keyword">def</span> savePods<span class="token punctuation">(</span>pods<span class="token operator">:</span> Map<span class="token punctuation">[</span>PodAddress<span class="token punctuation">,</span> Pod<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Task<span class="token punctuation">[</span><span class="token builtin">Unit</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>For testing, you can use the <code>Storage.memory</code> layer that keeps data in memory.</p> <p>Shardcake provides an implementation of <code>Storage</code> using Redis with the Redis4cats library (there's also an alternative using Redisson). To use it, add the following dependency:</p> <div class="language-scala extra-class"><pre class="language-scala"><code>libraryDependencies <span class="token operator">+=</span> <span class="token string">&quot;com.devsisters&quot;</span> <span class="token operator">%</span><span class="token operator">%</span> <span class="token string">&quot;shardcake-storage-redis&quot;</span> <span class="token operator">%</span> <span class="token string">&quot;2.1.0&quot;</span>
</code></pre></div><p>You can then simply use the <code>StorageRedis.live</code> layer.</p> <p>It requires a <code>RedisConfig</code> with the following options:</p> <ul><li><code>assignmentsKey</code>: the key to store shard assignments in Redis</li> <li><code>podsKey</code>: the key to store registered pods in Redis</li></ul> <p>It also requires a <code>Redis</code> object, which is an alias to <code>RedisCommands[Task, String, String] with PubSubCommands[fs2Stream, String, String]</code> from the <a href="https://redis4cats.profunktor.dev/" target="_blank" rel="noopener noreferrer">redis4cats<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> library used under the hood.
Here's an example how to build it:</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>devsisters<span class="token punctuation">.</span>shardcake<span class="token punctuation">.</span></span>StorageRedis<span class="token punctuation">.</span>Redis
<span class="token keyword">import</span> <span class="token namespace">dev<span class="token punctuation">.</span>profunktor<span class="token punctuation">.</span>redis4cats<span class="token punctuation">.</span></span>Redis
<span class="token keyword">import</span> <span class="token namespace">dev<span class="token punctuation">.</span>profunktor<span class="token punctuation">.</span>redis4cats<span class="token punctuation">.</span>connection<span class="token punctuation">.</span></span>RedisClient
<span class="token keyword">import</span> <span class="token namespace">dev<span class="token punctuation">.</span>profunktor<span class="token punctuation">.</span>redis4cats<span class="token punctuation">.</span>data<span class="token punctuation">.</span></span>RedisCodec
<span class="token keyword">import</span> <span class="token namespace">dev<span class="token punctuation">.</span>profunktor<span class="token punctuation">.</span>redis4cats<span class="token punctuation">.</span>effect<span class="token punctuation">.</span></span>Log
<span class="token keyword">import</span> <span class="token namespace">dev<span class="token punctuation">.</span>profunktor<span class="token punctuation">.</span>redis4cats<span class="token punctuation">.</span>pubsub<span class="token punctuation">.</span></span>PubSub
<span class="token keyword">import</span> <span class="token namespace">zio<span class="token punctuation">.</span>interop<span class="token punctuation">.</span>catz<span class="token punctuation">.</span></span>_
<span class="token keyword">import</span> <span class="token namespace">zio<span class="token punctuation">.</span></span><span class="token punctuation">{</span> Task<span class="token punctuation">,</span> ZEnvironment<span class="token punctuation">,</span> ZIO<span class="token punctuation">,</span> ZLayer <span class="token punctuation">}</span>

<span class="token keyword">val</span> redis<span class="token operator">:</span> ZLayer<span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span> Throwable<span class="token punctuation">,</span> Redis<span class="token punctuation">]</span> <span class="token operator">=</span>
  ZLayer<span class="token punctuation">.</span>scopedEnvironment <span class="token punctuation">{</span>
    <span class="token keyword">implicit</span> <span class="token keyword">val</span> runtime<span class="token operator">:</span> zio<span class="token punctuation">.</span>Runtime<span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">]</span> <span class="token operator">=</span> zio<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>default
    <span class="token keyword">implicit</span> <span class="token keyword">val</span> logger<span class="token operator">:</span> Log<span class="token punctuation">[</span>Task<span class="token punctuation">]</span>         <span class="token operator">=</span> <span class="token keyword">new</span> Log<span class="token punctuation">[</span>Task<span class="token punctuation">]</span> <span class="token punctuation">{</span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> debug<span class="token punctuation">(</span>msg<span class="token operator">:</span> <span class="token keyword">=&gt;</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> Task<span class="token punctuation">[</span><span class="token builtin">Unit</span><span class="token punctuation">]</span> <span class="token operator">=</span> ZIO<span class="token punctuation">.</span>unit
      <span class="token keyword">override</span> <span class="token keyword">def</span> error<span class="token punctuation">(</span>msg<span class="token operator">:</span> <span class="token keyword">=&gt;</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> Task<span class="token punctuation">[</span><span class="token builtin">Unit</span><span class="token punctuation">]</span> <span class="token operator">=</span> ZIO<span class="token punctuation">.</span>logError<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> info<span class="token punctuation">(</span>msg<span class="token operator">:</span> <span class="token keyword">=&gt;</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> Task<span class="token punctuation">[</span><span class="token builtin">Unit</span><span class="token punctuation">]</span>  <span class="token operator">=</span> ZIO<span class="token punctuation">.</span>logDebug<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">(</span><span class="token keyword">for</span> <span class="token punctuation">{</span>
      client   <span class="token keyword">&lt;-</span> RedisClient<span class="token punctuation">[</span>Task<span class="token punctuation">]</span><span class="token punctuation">.</span>from<span class="token punctuation">(</span><span class="token string">&quot;redis://foobared@localhost&quot;</span><span class="token punctuation">)</span>
      commands <span class="token keyword">&lt;-</span> Redis<span class="token punctuation">[</span>Task<span class="token punctuation">]</span><span class="token punctuation">.</span>fromClient<span class="token punctuation">(</span>client<span class="token punctuation">,</span> RedisCodec<span class="token punctuation">.</span>Utf8<span class="token punctuation">)</span>
      pubSub   <span class="token keyword">&lt;-</span> PubSub<span class="token punctuation">.</span>mkPubSubConnection<span class="token punctuation">[</span>Task<span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> RedisCodec<span class="token punctuation">.</span>Utf8<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">yield</span> ZEnvironment<span class="token punctuation">(</span>commands<span class="token punctuation">,</span> pubSub<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toScopedZIO
  <span class="token punctuation">}</span>
</code></pre></div><h2 id="messaging-protocol"><a href="#messaging-protocol" class="header-anchor">#</a> Messaging Protocol</h2> <p>The <code>Pods</code> trait defines how to communicate with remote pods.
It is used both by the Shard Manager for assigning and unassigning shards, and by pods for internal communication (forward messages to each other).</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">trait</span> Pods <span class="token punctuation">{</span>
  <span class="token keyword">def</span> assignShards<span class="token punctuation">(</span>pod<span class="token operator">:</span> PodAddress<span class="token punctuation">,</span> shards<span class="token operator">:</span> Set<span class="token punctuation">[</span>ShardId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Task<span class="token punctuation">[</span><span class="token builtin">Unit</span><span class="token punctuation">]</span>
  <span class="token keyword">def</span> unassignShards<span class="token punctuation">(</span>pod<span class="token operator">:</span> PodAddress<span class="token punctuation">,</span> shards<span class="token operator">:</span> Set<span class="token punctuation">[</span>ShardId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Task<span class="token punctuation">[</span><span class="token builtin">Unit</span><span class="token punctuation">]</span>
  <span class="token keyword">def</span> ping<span class="token punctuation">(</span>pod<span class="token operator">:</span> PodAddress<span class="token punctuation">)</span><span class="token operator">:</span> Task<span class="token punctuation">[</span><span class="token builtin">Unit</span><span class="token punctuation">]</span>
  
  <span class="token keyword">def</span> sendMessage<span class="token punctuation">(</span>pod<span class="token operator">:</span> PodAddress<span class="token punctuation">,</span> message<span class="token operator">:</span> BinaryMessage<span class="token punctuation">)</span><span class="token operator">:</span> Task<span class="token punctuation">[</span>Option<span class="token punctuation">[</span>Array<span class="token punctuation">[</span><span class="token builtin">Byte</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
  <span class="token keyword">def</span> sendMessageStreaming<span class="token punctuation">(</span>pod<span class="token operator">:</span> PodAddress<span class="token punctuation">,</span> message<span class="token operator">:</span> BinaryMessage<span class="token punctuation">)</span><span class="token operator">:</span> ZStream<span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span> Throwable<span class="token punctuation">,</span> Array<span class="token punctuation">[</span><span class="token builtin">Byte</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>For testing, you can use the <code>Pods.noop</code> layer that does nothing.</p> <p>Shardcake provides an implementation of <code>Pods</code> using the gRPC protocol. To use it, add the following dependency:</p> <div class="language-scala extra-class"><pre class="language-scala"><code>libraryDependencies <span class="token operator">+=</span> <span class="token string">&quot;com.devsisters&quot;</span> <span class="token operator">%</span><span class="token operator">%</span> <span class="token string">&quot;shardcake-protocol-grpc&quot;</span> <span class="token operator">%</span> <span class="token string">&quot;2.1.0&quot;</span>
</code></pre></div><p>You can then simply use the <code>GrpcPods.live</code> layer.</p> <p>On pods, you also need expose the gRPC API. This is done by adding the <code>GrpcShardingService.live</code> layer to your environment. You don't need this one on the Shard Manager.</p> <h2 id="serialization"><a href="#serialization" class="header-anchor">#</a> Serialization</h2> <p>The <code>Serialization</code> trait defines how to serialize user messages that will be sent between pods.
It contains 2 methods <code>encode</code> and <code>decode</code> that define how to transform a give type from and to bytes.</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">trait</span> Serialization <span class="token punctuation">{</span>
  <span class="token keyword">def</span> encode<span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">Any</span><span class="token punctuation">)</span><span class="token operator">:</span> Task<span class="token punctuation">[</span>Array<span class="token punctuation">[</span><span class="token builtin">Byte</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
  <span class="token keyword">def</span> decode<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">(</span>bytes<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">Byte</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Task<span class="token punctuation">[</span>A<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>For testing, you can use the <code>Serialization.javaSerialization</code> layer that uses Java Serialization (not recommended in production).</p> <p>Shardcake provides an implementation of <code>Serialization</code> using the <a href="https://github.com/EsotericSoftware/kryo" target="_blank" rel="noopener noreferrer">Kryo<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> binary serialization library. To use it, add the following dependency:</p> <div class="language-scala extra-class"><pre class="language-scala"><code>libraryDependencies <span class="token operator">+=</span> <span class="token string">&quot;com.devsisters&quot;</span> <span class="token operator">%</span><span class="token operator">%</span> <span class="token string">&quot;shardcake-serialization-kryo&quot;</span> <span class="token operator">%</span> <span class="token string">&quot;2.1.0&quot;</span>
</code></pre></div><p>You can then simply use the <code>KryoSerialization.live</code> layer.</p> <div class="custom-block tip"><p class="custom-block-title">Server updates and message versioning</p> <ul><li>Messages are not persisted, which means that if you stop and restart the whole system, you can change anything in the messages format.</li> <li>On the other hand, if you wish to do rolling updates (update servers progressively without downtime), you need to be careful with changes in the messages format.</li> <li>What you can do largely depends on your serialization mechanism, some solutions allow changes while some others are very restrictive.
<a href="https://github.com/EsotericSoftware/kryo" target="_blank" rel="noopener noreferrer">Kryo<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> by default is pretty strict and won't support most changes, but there are settings to support more (at the cost of some performance or message size).</li> <li>When you can't modify existing messages, an option is to create new messages that won't be used until the rolling update is finished (so you won't have cases where old nodes receive new messages).</li></ul></div> <h2 id="health"><a href="#health" class="header-anchor">#</a> Health</h2> <p>The <code>PodsHealth</code> trait defines how to know if a pod is still alive or is dead (in which case, we should reassign all its shards).</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">trait</span> PodsHealth <span class="token punctuation">{</span>
  <span class="token keyword">def</span> isAlive<span class="token punctuation">(</span>podAddress<span class="token operator">:</span> PodAddress<span class="token punctuation">)</span><span class="token operator">:</span> UIO<span class="token punctuation">[</span><span class="token builtin">Boolean</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>For testing, you can use the <code>PodsHealth.noop</code> layer that always returns true, or the <code>PodsHealth.local</code> layer that uses <code>ping</code> from the <a href="#messaging-protocol">Messaging Protocol</a> to check if a pod is alive.</p> <p>Shardcake provides an implementation of <code>PodsHealth</code> using the <a href="https://kubernetes.io" target="_blank" rel="noopener noreferrer">Kubernetes<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> API. To use it, add the following dependency:</p> <div class="language-scala extra-class"><pre class="language-scala"><code>libraryDependencies <span class="token operator">+=</span> <span class="token string">&quot;com.devsisters&quot;</span> <span class="token operator">%</span><span class="token operator">%</span> <span class="token string">&quot;shardcake-health-k8s&quot;</span> <span class="token operator">%</span> <span class="token string">&quot;2.1.0&quot;</span>
</code></pre></div><p>You can then simply use the <code>K8sPodsHealth.live</code> layer. This is requiring a <code>Pods</code> layer that comes from <a href="https://coralogix.github.io/zio-k8s/docs/overview/overview_gettingstarted" target="_blank" rel="noopener noreferrer">zio-k8s<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <div class="custom-block tip"><p class="custom-block-title">Examples</p> <p>Check the <a href="https://github.com/devsisters/shardcake/tree/series/2.x/examples/src/main/scala/example/complex" target="_blank" rel="noopener noreferrer">examples<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> folder that contains a full example using Redis, gRPC and Kryo seralization.</p></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/shardcake/docs/config.html" class="prev">
        Configuration
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/shardcake/assets/js/app.f77f888a.js" defer></script><script src="/shardcake/assets/js/2.778bb4ad.js" defer></script><script src="/shardcake/assets/js/1.f8bb34da.js" defer></script><script src="/shardcake/assets/js/27.88bc0b43.js" defer></script>
  </body>
</html>
