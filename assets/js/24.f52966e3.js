(window.webpackJsonp=window.webpackJsonp||[]).push([[24],{304:function(t,s,e){"use strict";e.r(s);var a=e(14),n=Object(a.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"getting-started"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#getting-started"}},[t._v("#")]),t._v(" Getting Started")]),t._v(" "),s("p",[s("strong",[t._v("Shardcake")]),t._v(" is a "),s("strong",[t._v("Scala open source library")]),t._v(" that makes it easy to distribute entities across multiple servers and interact with those entities using their ID without knowing their actual location (this is also known as "),s("em",[t._v("location transparency")]),t._v(").")]),t._v(" "),s("p",[t._v("Shardcake exposes a "),s("strong",[t._v("purely functional API")]),t._v(" and depends heavily on "),s("a",{attrs:{href:"https://zio.dev",target:"_blank",rel:"noopener noreferrer"}},[t._v("ZIO"),s("OutboundLink")],1),t._v(". It is recommended to be familiar with ZIO to read this documentation.")]),t._v(" "),s("h2",{attrs:{id:"a-simple-use-case"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#a-simple-use-case"}},[t._v("#")]),t._v(" A simple use case")]),t._v(" "),s("p",[t._v("We are building a multiplayer game where "),s("strong",[t._v("users")]),t._v(" can join "),s("strong",[t._v("guilds")]),t._v(".\nWe expect our game to be successful, so we need to be able to scale out (deploy it on multiple servers to handle the load).")]),t._v(" "),s("p",[t._v("A guild is limited to 30 members.\nLet's consider the case where 2 users try to join a guild at the exact same time, but our guild already had 29 members.")]),t._v(" "),s("p",[s("img",{attrs:{src:"/shardcake/usecase1.png",alt:"naive diagram"}})]),t._v(" "),s("p",[t._v("If we implement this naively, 2 different servers might receive our 2 requests to join the guild.\nThey will both check the current size of the guild at the same time, which will be 29 and they will both accept the new guild member. Now our guild has 31 members ðŸ˜±.")]),t._v(" "),s("p",[t._v("There are 2 common approaches to deal with this issue:")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("Global lock")]),t._v(" approach: when checking the members of the guild, acquire a lock that is shared between the different game servers, and release it after saving the new member.\nThat way, if 2 different game servers try to do it at the same time, the 2nd one will wait for the first one to finish.")]),t._v(" "),s("li",[s("strong",[t._v("Single writer")]),t._v(" approach: instead of handling the requests on 2 game servers concurrently, redirect the 2 requests to a single entity that will handle them sequentially.")])]),t._v(" "),s("p",[s("strong",[t._v("Entity Sharding")]),t._v(" is a way to implement the second approach. In this case our entities (here, our guilds) will be spread across our game servers so that\neach entity exists in only one place at the time.")]),t._v(" "),s("p",[s("img",{attrs:{src:"/shardcake/usecase2.png",alt:"single writer diagram"}})]),t._v(" "),s("p",[t._v("If our entity might be on any game server, how do we know where it is? This is the second characteristic of entity sharding, known as location transparency: we only need to know the entity ID.\nUsing the entity ID, the sharding system will be able to find on which server the entity is located.")]),t._v(" "),s("p",[s("strong",[t._v("Shardcake")]),t._v(" provides components to:")]),t._v(" "),s("ul",[s("li",[t._v("automatically manage the assignments of entities to game servers")]),t._v(" "),s("li",[t._v("send messages to your entities using their IDs")])]),t._v(" "),s("p",[t._v("Once sharding is setup, it will let you write code like the following (sending a message to guild regardless of its location):")]),t._v(" "),s("div",{staticClass:"language-scala extra-class"},[s("pre",{pre:!0,attrs:{class:"language-scala"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" joinGuild"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("guildId"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" GuildId"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ZIO"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("Context"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Throwable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" GuildState"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    userId     "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("<-")]),t._v(" getCurrentUserFromContext\n    guildState "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("<-")]),t._v(" guild"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("send"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("guildId"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("JoinGuild"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("userId"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" _"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("yield")]),t._v(" guildState\n")])])]),s("h2",{attrs:{id:"terminology"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#terminology"}},[t._v("#")]),t._v(" Terminology")]),t._v(" "),s("p",[t._v("Before we go further, let's define a few terms:")]),t._v(" "),s("ul",[s("li",[t._v("An "),s("strong",[t._v("entity")]),t._v(" is a small message handler that can be addressed by ID.\nFor example, "),s("code",[t._v("User A")]),t._v(" or "),s("code",[t._v("Guild B")]),t._v(" are entities. In this case we say that "),s("code",[t._v("User")]),t._v(" and "),s("code",[t._v("Guild")]),t._v(" are "),s("strong",[t._v("entity types")]),t._v(".")]),t._v(" "),s("li",[t._v("A "),s("strong",[t._v("pod")]),t._v(" is an application server that can host entities.\nEntities usually run on multiple pods, but a single entity will only run on a single pod at the time. You will never have the same entity running on 2 different pods.")]),t._v(" "),s("li",[t._v("A "),s("strong",[t._v("shard")]),t._v(" is a logical group of entities that will always be located on the same pod.\nThere might be millions of entities, so instead of keeping millions of entities-to-pods mappings, we group entities into shards and maintain reasonably-sized shards-to-pods mappings.")])]),t._v(" "),s("h2",{attrs:{id:"key-components"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#key-components"}},[t._v("#")]),t._v(" Key components")]),t._v(" "),s("p",[t._v("Shardcake is composed of 2 main components:")]),t._v(" "),s("ul",[s("li",[t._v("The "),s("strong",[t._v("Shard Manager")]),t._v(" is an independent component that needs a single instance running. It is in charge of assigning shards to pods.")]),t._v(" "),s("li",[s("strong",[t._v("Entities")]),t._v(" will run on your application servers and process messages that are sent to them. Note that the entity behavior (including entity persistence) is entirely up to you.\nShardcake only takes care of starting entities on the right pods as well as the communication between them.")])]),t._v(" "),s("p",[t._v("There are 4 pluggable parts that can be implemented with the technology of your choice.")]),t._v(" "),s("ul",[s("li",[t._v("The "),s("code",[t._v("Storage")]),t._v(" trait defines where shard assignments will be stored. Shardcake provides an implementation using "),s("strong",[t._v("Redis")]),t._v(".")]),t._v(" "),s("li",[t._v("The "),s("code",[t._v("Pods")]),t._v(" trait defines how to communicate with remote pods. Shardcake provides an implementation using "),s("strong",[t._v("gRPC")]),t._v(" as the protocol.")]),t._v(" "),s("li",[t._v("The "),s("code",[t._v("Serialization")]),t._v(" defines how to encode and decode messages. Shardcake provides an implementation using "),s("strong",[t._v("Kryo")]),t._v(".")]),t._v(" "),s("li",[t._v("The "),s("code",[t._v("PodsHealth")]),t._v(" trait defines how to check if a pod is healthy or not. Shardcake provides an implementation using the "),s("strong",[t._v("k8s API")]),t._v(".")])]),t._v(" "),s("p",[s("img",{attrs:{src:"/shardcake/arch.png",alt:"architecture diagram"}})]),t._v(" "),s("h2",{attrs:{id:"an-example"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#an-example"}},[t._v("#")]),t._v(" An example")]),t._v(" "),s("h3",{attrs:{id:"shard-manager"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#shard-manager"}},[t._v("#")]),t._v(" Shard Manager")]),t._v(" "),s("p",[t._v("The first thing we need to do is starting the Shard Manager. This component is available by importing the "),s("code",[t._v("shardcake-manager")]),t._v(" dependency, and requires implementations of "),s("code",[t._v("Storage")]),t._v(", "),s("code",[t._v("Pods")]),t._v(" and "),s("code",[t._v("PodsHealth")]),t._v(" to work.")]),t._v(" "),s("p",[t._v("To make it simpler and run our example without 3rd parties, we're going to run a simple "),s("code",[t._v("PodsHealth")]),t._v(" implementation that just pings a pod to see if it's alive, and in-memory "),s("code",[t._v("Storage")]),t._v(".\nWe need a proper messaging protocol to communicate with pods, so we're going to use "),s("code",[t._v("shardcake-protocol-grpc")]),t._v(".")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('libraryDependencies += "com.devsisters" %% "shardcake-manager"       % "2.1.0"\nlibraryDependencies += "com.devsisters" %% "shardcake-protocol-grpc" % "2.1.0"\n')])])]),s("p",[t._v("The Shard Manager exposes a small GraphQL API, which means we need to start a small webserver. This can be done by calling "),s("code",[t._v("Server.run")]),t._v(" and providing all the required dependencies.")]),t._v(" "),s("div",{staticClass:"language-scala extra-class"},[s("pre",{pre:!0,attrs:{class:"language-scala"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("com"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("devsisters"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("shardcake"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),t._v("_\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("com"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("devsisters"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("shardcake"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("interfaces"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),t._v("_\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("zio"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),t._v("_\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("object")]),t._v(" ShardManagerApp "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" ZIOAppDefault "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" run"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Task"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("Nothing")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n    Server"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("run"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("provide"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n      ZLayer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("succeed"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ManagerConfig"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("default"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      ZLayer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("succeed"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("GrpcConfig"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("default"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      PodsHealth"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("local"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// just ping a pod to see if it's alive")]),t._v("\n      GrpcPods"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("live"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// use gRPC protocol")]),t._v("\n      Storage"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("memory"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("   "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// store data in memory")]),t._v("\n      ShardManager"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("live "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// shard manager logic")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("That's it! Running this small app will start the Shard Manager and its API. It is now ready to receive registration from pods.")]),t._v(" "),s("h3",{attrs:{id:"entity-behavior"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#entity-behavior"}},[t._v("#")]),t._v(" Entity Behavior")]),t._v(" "),s("p",[t._v("We now need to define our "),s("strong",[t._v("entity behavior")]),t._v(": what kind of messages can our entity receive, and what to do when it receives those messages. We will model our "),s("strong",[t._v("Guild")]),t._v(" example.")]),t._v(" "),s("p",[t._v("First, we need the following dependencies:")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('libraryDependencies += "com.devsisters" %% "shardcake-entities"      % "2.1.0"\nlibraryDependencies += "com.devsisters" %% "shardcake-protocol-grpc" % "2.1.0"\n')])])]),s("p",[t._v("Let's start with defining the messages our entities can receive. We will have 2: one for joining a guild and one for leaving.\nWe create a "),s("code",[t._v("sealed trait")]),t._v(" that will contain all the possible message types.\nAny message that can be replied needs to contain a "),s("code",[t._v("Replier[A]")]),t._v(" where "),s("code",[t._v("A")]),t._v(" is the response type.")]),t._v(" "),s("div",{staticClass:"language-scala extra-class"},[s("pre",{pre:!0,attrs:{class:"language-scala"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sealed")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("trait")]),t._v(" GuildMessage\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("object")]),t._v(" GuildMessage "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" Join"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("userId"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" replier"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Replier"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("Try"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("Set"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" GuildMessage\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" Leave"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("userId"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("                                    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" GuildMessage\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("We also need to define an "),s("strong",[t._v("Entity Type")]),t._v(". This is done by extending "),s("code",[t._v("EntityType")]),t._v(" with the message type as well as a unique "),s("code",[t._v("String")]),t._v(" identifier for this type.")]),t._v(" "),s("div",{staticClass:"language-scala extra-class"},[s("pre",{pre:!0,attrs:{class:"language-scala"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("object")]),t._v(" Guild "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" EntityType"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("GuildMessage"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"guild"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[t._v("The behavior itself is a function with the following signature:")]),t._v(" "),s("div",{staticClass:"language-scala extra-class"},[s("pre",{pre:!0,attrs:{class:"language-scala"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" behavior"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("entityId"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" messages"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Queue"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("GuildMessage"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" RIO"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("Sharding"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("Nothing")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),s("p",[t._v("It takes an "),s("code",[t._v("entityId")]),t._v(" and a "),s("code",[t._v("Queue[GuildMessage]")]),t._v(" and returns a "),s("code",[t._v("ZIO")]),t._v(" that never ends (hence the return type "),s("code",[t._v("Nothing")]),t._v(").\nThat function is just supposed to consume "),s("code",[t._v("messages")]),t._v(" forever.")]),t._v(" "),s("p",[t._v("Let's first define how to handle a single "),s("code",[t._v("GuildMessage")]),t._v(".")]),t._v(" "),s("p",[t._v("We will use a "),s("code",[t._v("Ref[Set[String]]")]),t._v(" to hold our state (the list of users in the guild).\nWhen we receive a "),s("code",[t._v("Join")]),t._v(" request, we check if the guild is already full (here, we hardcode the max to 5) and respond with a failure or modify the state and respond with a success.\nWe use "),s("code",[t._v("replier.reply")]),t._v(" to send a response to the sender (here, sending the full list of guild members wrapped in a "),s("code",[t._v("Try")]),t._v(" to express errors).")]),t._v(" "),s("div",{staticClass:"language-scala extra-class"},[s("pre",{pre:!0,attrs:{class:"language-scala"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" handleMessage"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("state"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Ref"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("Set"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" message"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" GuildMessage"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" RIO"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("Sharding"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("Unit")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n  message "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("match")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" GuildMessage"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Join"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("userId"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" replier"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("=>")]),t._v("\n      state"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("flatMap"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("members "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("=>")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("members"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("size "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n          replier"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("reply"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Failure"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" Exception"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Guild is already full!"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v("\n          state"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("updateAndGet"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("_ "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" userId"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("flatMap "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" newMembers "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("=>")]),t._v("\n            replier"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("reply"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Success"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("newMembers"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" GuildMessage"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Leave"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("userId"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("         "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("=>")]),t._v("\n      state"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("update"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("_ "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" userId"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("We are now ready to create our behavior, starting from an empty state when the entity is created:")]),t._v(" "),s("div",{staticClass:"language-scala extra-class"},[s("pre",{pre:!0,attrs:{class:"language-scala"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" behavior"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("entityId"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" messages"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Queue"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("GuildMessage"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" RIO"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("Sharding"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("Nothing")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n  Ref\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("make"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Set"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("empty"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("flatMap"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("state "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("=>")]),t._v(" messages"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("take"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("flatMap"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("handleMessage"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("state"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" _"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("forever"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("h3",{attrs:{id:"run-the-application"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#run-the-application"}},[t._v("#")]),t._v(" Run the application")]),t._v(" "),s("p",[t._v("To run our entities, we need to register their behavior to the Sharding system, which is done by calling "),s("code",[t._v("Sharding.registerEntity")]),t._v(", passing the entity type and the behavior.")]),t._v(" "),s("p",[t._v("We then need to notify the Shard Manager that a new pod is now ready to run entities, and shards may be assigned to it.\nThis is done by calling "),s("code",[t._v("Sharding.registerScoped")]),t._v(" (which is the equivalent of calling "),s("code",[t._v("Sharding.register")]),t._v(" when the program starts and "),s("code",[t._v("Sharding.unregister")]),t._v(" when the program ends).")]),t._v(" "),s("p",[t._v("To communicate with our entities, we need a "),s("code",[t._v("Messenger[GuildMessage]")]),t._v(", which we get by calling "),s("code",[t._v("Sharding.messenger")]),t._v(". You can even use "),s("code",[t._v("messenger")]),t._v(" on a pod that is not hosting any entities.")]),t._v(" "),s("div",{staticClass:"language-scala extra-class"},[s("pre",{pre:!0,attrs:{class:"language-scala"}},[s("code",[t._v("  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" program "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      _     "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("<-")]),t._v(" Sharding"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("registerEntity"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Guild"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" behavior"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      _     "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("<-")]),t._v(" Sharding"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("registerScoped\n      guild "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("<-")]),t._v(" Sharding"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("messenger"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Guild"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      _     "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("<-")]),t._v(" guild"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("send"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"guild1"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Join"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"user1"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" _"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("debug\n      _     "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("<-")]),t._v(" guild"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("send"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"guild1"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Join"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"user2"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" _"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("debug\n      _     "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("<-")]),t._v(" guild"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("send"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"guild1"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Join"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"user3"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" _"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("debug\n      _     "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("<-")]),t._v(" guild"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("send"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"guild1"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Join"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"user4"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" _"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("debug\n      _     "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("<-")]),t._v(" guild"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("send"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"guild1"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Join"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"user5"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" _"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("debug\n      _     "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("<-")]),t._v(" guild"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("send"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"guild1"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Join"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"user6"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" _"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("debug\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("yield")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[t._v("Finally, we provide all required dependencies as we did for the Shard Manager.")]),t._v(" "),s("div",{staticClass:"language-scala extra-class"},[s("pre",{pre:!0,attrs:{class:"language-scala"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" run"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Task"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("Unit")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n  ZIO"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("scoped"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("program"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("provide"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    ZLayer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("succeed"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("default"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    ZLayer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("succeed"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("GrpcConfig"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("default"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    Serialization"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("javaSerialization"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// use java serialization for messages")]),t._v("\n    Storage"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("memory"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("                  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// store data in memory")]),t._v("\n    ShardManagerClient"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("liveWithSttp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// client to communicate with the Shard Manager")]),t._v("\n    GrpcPods"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("live"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("                   "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// use gRPC protocol")]),t._v("\n    GrpcShardingService"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("live"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// expose gRPC service")]),t._v("\n    Sharding"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("live                    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// sharding logic")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[t._v("We can now run our program. It will successively send 6 "),s("code",[t._v("Join")]),t._v(" messages to our guild and print the result:")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("Success(Set(user1))\nSuccess(Set(user1, user2))\nSuccess(Set(user1, user2, user3))\nSuccess(Set(user1, user2, user3, user4))\nSuccess(HashSet(user1, user5, user4, user2, user3))\nFailure(java.lang.Exception: Guild is already full!)\n")])])]),s("h4",{attrs:{id:"one-more-thing"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#one-more-thing"}},[t._v("#")]),t._v(" One more thing...")]),t._v(" "),s("p",[s("code",[t._v("Sharding")]),t._v(" also exposes 2 methods that can be interesting for some use cases:")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("registerSingleton")]),t._v(" lets you register some background processes that will run in only one pod at any given time. Singletons can't receive messages and they are not stopped in case of inactivity.")]),t._v(" "),s("li",[s("code",[t._v("registerTopic")]),t._v(" lets you broadcast messages to all registered pods (use "),s("code",[t._v("Sharding.broadcaster")]),t._v(" instead of "),s("code",[t._v("Sharding.messenger")]),t._v(").")])]),t._v(" "),s("h3",{attrs:{id:"where-to-go-from-there"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#where-to-go-from-there"}},[t._v("#")]),t._v(" Where to go from there?")]),t._v(" "),s("p",[t._v("In this simple example, we only had a single pod so there was no real benefit from using sharding.\nBut we could run the exact same code on multiple pods, and the sharding system would ensure that each guild is only running on a single pod.\nIn other words, all messages sent to "),s("code",[t._v("guild1")]),t._v(" would be handled by the same pod.")]),t._v(" "),s("p",[t._v("The only changes we would need to make would be:")]),t._v(" "),s("ul",[s("li",[t._v("to use an actual "),s("code",[t._v("Storage")]),t._v(" implementation for sharding (e.g. Redis)")]),t._v(" "),s("li",[t._v("to save our guild state somewhere instead of in memory, so that we don't lose this state if the guild entity is moved from one pod to another")])]),t._v(" "),s("p",[t._v("The running code for this example "),s("a",{attrs:{href:"https://github.com/devsisters/shardcake/tree/series/2.x/examples/src/main/scala/example/simple",target:"_blank",rel:"noopener noreferrer"}},[t._v("can be found here"),s("OutboundLink")],1),t._v(",\nas well as "),s("a",{attrs:{href:"https://github.com/devsisters/shardcake/tree/series/2.x/examples/src/main/scala/example/complex",target:"_blank",rel:"noopener noreferrer"}},[t._v("a more complex example"),s("OutboundLink")],1),t._v(" using Redis to persist data and where you can run multiple pods.")]),t._v(" "),s("p",[t._v("To understand how Sharding works under the hood, have a look at the "),s("RouterLink",{attrs:{to:"/docs/architecture.html"}},[t._v("Architecture")]),t._v(" section.\nThe "),s("RouterLink",{attrs:{to:"/docs/config.html"}},[t._v("Configuration")]),t._v(" section explains how to configure the sharding system.\nFinally, the "),s("RouterLink",{attrs:{to:"/docs/customization.html"}},[t._v("Customization")]),t._v(" section describes how you can use your own storage, serialization or messaging protocol, as well as the options provided by Shardcake.")],1),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("Differences with Akka Cluster Sharding ?")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://doc.akka.io/docs/akka/current/typed/cluster-sharding.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Akka Cluster Sharding"),s("OutboundLink")],1),t._v(" is the main alternative for sharding in Scala.\nHere is how Shardcake differs from Akka:")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("Shardcake is a "),s("strong",[t._v("purely functional library")]),t._v(" based on "),s("code",[t._v("ZIO")]),t._v(', while Akka is a library leaning towards the "better Java" style of Scala and is based on '),s("code",[t._v("Future")]),t._v(".")])]),t._v(" "),s("li",[s("p",[t._v("With Akka, all application servers "),s("strong",[t._v("must be part of a cluster")]),t._v(". This is particularly tricky to configure and sensitive to all kinds of failures.\nThis is not the case with Shardcake since the Shard Manager is an external component that relies on systems like Kubernetes to monitor pod health.")])]),t._v(" "),s("li",[s("p",[t._v("Akka is way more than a sharding library, this is basically an entire framework that has a lot of features.\nShardcake is much "),s("strong",[t._v("simpler and modular")]),t._v(". It lets you customize multiple things, including the messaging protocol between pods.")])]),t._v(" "),s("li",[s("p",[t._v("Akka is backed by "),s("a",{attrs:{href:"https://www.lightbend.com",target:"_blank",rel:"noopener noreferrer"}},[t._v("Lightbend"),s("OutboundLink")],1),t._v(", who provides "),s("strong",[t._v("commercial support")]),t._v(",\nwhile Shardcake is backed by "),s("a",{attrs:{href:"https://www.devsisters.com",target:"_blank",rel:"noopener noreferrer"}},[t._v("Devsisters"),s("OutboundLink")],1),t._v(" and the "),s("strong",[t._v("ZIO community")]),t._v(".")])])])])])}),[],!1,null,null,null);s.default=n.exports}}]);